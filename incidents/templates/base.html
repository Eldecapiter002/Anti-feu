<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Anti-feu — Bukavu</title>
  <!-- Bootstrap CDN -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.min.css"/>
  <style>
    body { padding-top: 70px; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
    #map { height: 60vh; width: 100%; }
    .card-compact { padding: 0.8rem; }
  </style>
</head>
<body>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const mapEl = document.getElementById('map');
  const spinner = document.getElementById('map-spinner');

  if (typeof L === 'undefined') {
    if (spinner) spinner.style.display = 'none';
    if (mapEl) {
      mapEl.style.display = 'block';
      mapEl.innerHTML = '<div class="alert alert-danger m-3">Leaflet non chargé. Vérifie les CDN dans base.html.</div>';
    }
    console.error('Leaflet non chargé (L is undefined).');
    return;
  }

  if (mapEl && (!mapEl.style.height || mapEl.style.height === '')) {
    mapEl.style.height = '60vh';
  }
  if (spinner) spinner.style.display = 'none';
  if (mapEl) mapEl.style.display = 'block';

  let map;
  try {
    map = L.map('map').setView([-2.5, 28.8], 12);
  } catch (e) {
    console.error('Erreur création map Leaflet:', e);
    if (mapEl) mapEl.innerHTML = '<div class="alert alert-danger m-3">Impossible d\'initialiser la carte.</div>';
    return;
  }

  // Déclarer les layers nommés (important: les variables doivent exister)
  const satellite = L.tileLayer(
    'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
    { maxZoom: 20, attribution: 'Tiles © Esri — Source: Esri, Maxar' }
  );

  const transportation = L.tileLayer(
    'https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Transportation/MapServer/tile/{z}/{y}/{x}',
    { maxZoom: 20, attribution: '© Esri Transportation' }
  );

  const labels = L.tileLayer(
    'https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}',
    { maxZoom: 20, attribution: '© Esri Boundaries' }
  );

  // couche routière OSM (nommée)
  const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap contributors'
  });

  // composite Satellite + labels (hybrid)
  const satelliteHybrid = L.layerGroup([satellite, transportation, labels]);

  // contrôles des couches
  const baseMaps = {
    "Routier (OSM)": osm,
    "Satellite + Labels (Esri)": satelliteHybrid
  };

  // ajoute control et couche par défaut
  L.control.layers(baseMaps).addTo(map);
  // mets OSM par défaut (change si tu veux le satellite par défaut)
  osm.addTo(map);

  // Layer group pour incidents
  const incidentsLayer = L.layerGroup().addTo(map);

  // fonction add marker (rouge)
  function addIncidentMarker(inc, openPopup=false) {
    const lat = parseFloat(inc.latitude);
    const lng = parseFloat(inc.longitude);
    if (isNaN(lat) || isNaN(lng)) return;
    const marker = L.circleMarker([lat, lng], {
      radius: 7,
      color: '#b91c1c',
      fillColor: '#fca5a5',
      weight: 2,
      fillOpacity: 0.9
    }).addTo(incidentsLayer);
    const popupHtml = `<strong>${inc.commune || ''} ${inc.quartier || ''}</strong><br/>${inc.date || ''} ${inc.time || ''}<br/><small>Cause: ${inc.cause || ''}</small>`;
    marker.bindPopup(popupHtml, {className: 'incident-popup-red'});
    if (openPopup) marker.openPopup();
  }

  // charger incidents
  function loadIncidents() {
    incidentsLayer.clearLayers();
    fetch('/api/incidents/')
      .then(r => {
        if(!r.ok) throw new Error('Erreur HTTP ' + r.status);
        return r.json();
      })
      .then(data => {
        const items = data.results || data;
        // debug rapide : affiche le nombre d'éléments dans la console
        console.log('Incidents reçus:', items.length || 0);
        if(!items || items.length === 0){
          L.marker([-2.5, 28.8]).addTo(incidentsLayer).bindPopup('Aucun incident enregistré').openPopup();
          return;
        }
        items.forEach(i => addIncidentMarker(i));
      })
      .catch(err => {
        console.error('Erreur lors du chargement des incidents:', err);
        const s = document.getElementById('stats');
        if (s) s.innerHTML = '<div class="alert alert-warning">Impossible de charger les incidents (voir console).</div>';
      });
  }
  loadIncidents();

  // stats rapides
  fetch('/api/incidents/stats/')
    .then(r => r.json())
    .then(d => {
      let html = '<ul class="list-group">';
      html += '<li class="list-group-item active">Incendies par commune</li>';
      (d.by_commune || []).slice(0,6).forEach(c => {
        html += `<li class="list-group-item d-flex justify-content-between align-items-center">${c.commune}<span class="badge bg-primary rounded-pill">${c.total}</span></li>`;
      });
      html += '</ul>';
      document.getElementById('stats').innerHTML = html;
    })
    .catch(()=> {
      document.getElementById('stats').innerHTML = '<div class="text-muted">Statistiques indisponibles</div>';
    });

});
</script>


<nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top">
  <div class="container-fluid">
    <a class="navbar-brand" href="{% url 'home' %}">Anti-feu Bukavu</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarsExample07"
      aria-controls="navbarsExample07" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarsExample07">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
        <li class="nav-item"><a class="nav-link" href="{% url 'geoloc' %}">Géolocalisation</a></li>
        <li class="nav-item"><a class="nav-link" href="{% url 'prediction' %}">Prédiction</a></li>
        <li class="nav-item"><a class="nav-link" href="{% url 'alert' %}">Alerte</a></li>
        <li class="nav-item"><a class="nav-link" href="{% url 'modelling' %}">Modélisation</a></li>
        <li class="nav-item"><a class="nav-link" href="{% url 'contact' %}">Contact</a></li>
      </ul>
      <form class="d-flex" role="search" id="site-search" onsubmit="event.preventDefault(); window.location='{% url 'search' %}?q='+document.getElementById('q').value;">
        <input id="q" class="form-control me-2" type="search" placeholder="Rechercher..." aria-label="Search">
        <button class="btn btn-outline-light" type="submit">Rechercher</button>
      </form>
    </div>
  </div>
</nav>

<main class="container">
  {% block content %}{% endblock %}
</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.min.js"></script>
</body>
</html>
