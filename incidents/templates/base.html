<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Anti-feu — Bukavu</title>
  <!-- Bootstrap CDN -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.min.css"/>
  <style>
    body { padding-top: 70px; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
    #map { height: 60vh; width: 100%; }
    .card-compact { padding: 0.8rem; }
  </style>
</head>
<body>

<script>
// Module utilitaire pour créer des cartes Leaflet réutilisables.
// Colle ceci dans base.html (juste avant </body>) et SUPPRIME les scripts d'initialisation automatiques.
window.MyMaps = (function(){
  function ensureElHeight(el, height='60vh'){
    if(!el.style.height || el.style.height === '') el.style.height = height;
    el.style.display = 'block';
  }

  function buildTileLayers(){
    const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19, attribution: '&copy; OpenStreetMap contributors'
    });

    const satellite = L.tileLayer(
      'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
      { maxZoom: 20, attribution: 'Tiles © Esri — Source: Esri, Maxar' }
    );
    const transportation = L.tileLayer(
      'https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Transportation/MapServer/tile/{z}/{y}/{x}',
      { maxZoom: 20, attribution: '© Esri Transportation' }
    );
    const labels = L.tileLayer(
      'https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}',
      { maxZoom: 20, attribution: '© Esri Boundaries' }
    );

    const satelliteHybrid = L.layerGroup([satellite, transportation, labels]);

    return { osm, satellite, transportation, labels, satelliteHybrid };
  }

  // Fonction publique : createMap({elId, center, zoom, defaultBase})
  function createMap(options){
    if(typeof L === 'undefined'){
      console.error('Leaflet non chargé. Vérifie les CDN dans base.html.');
      throw new Error('Leaflet non chargé');
    }
    const elId = options.elId || 'map';
    const el = document.getElementById(elId);
    if(!el){
      console.error('Element #' + elId + ' introuvable.');
      throw new Error('Element introuvable: #' + elId);
    }

    ensureElHeight(el, options.height || '60vh');

    const center = options.center || [-2.5, 28.8];
    const zoom = options.zoom || 12;

    // crée la map
    const map = L.map(elId).setView(center, zoom);

    // layers
    const tiles = buildTileLayers();

    const baseMaps = {
      "Routier (OSM)": tiles.osm,
      "Satellite + Labels (Esri)": tiles.satelliteHybrid
    };
    L.control.layers(baseMaps).addTo(map);

    // ajout de la couche de base par défaut
    const defaultBase = options.defaultBase || 'osm';
    if(defaultBase === 'satellite') tiles.satelliteHybrid.addTo(map);
    else tiles.osm.addTo(map);

    // layer group pour incidents
    const incidentsLayer = L.layerGroup().addTo(map);

    // fonction pour ajouter un marker rouge
    function addIncidentMarker(inc, openPopup=false){
      const lat = parseFloat(inc.latitude);
      const lng = parseFloat(inc.longitude);
      if(isNaN(lat) || isNaN(lng)) return null;
      const marker = L.circleMarker([lat, lng], {
        radius: 7,
        color: '#b91c1c',
        fillColor: '#fca5a5',
        weight: 2,
        fillOpacity: 0.9
      }).addTo(incidentsLayer);
      const popupHtml = `<strong>Cause: ${inc.cause || ''}</strong><br/>${inc.date || ''} ${inc.time || ''}<br/><small>notes : ${inc.notes || ''}</small>`;
      marker.bindPopup(popupHtml, {className: 'incident-popup-red'});
      if(openPopup) marker.openPopup();
      return marker;
    }

    // charge incidents depuis l'API (retourne la promesse)
    function loadIncidents(apiUrl='/api/incidents/'){
      incidentsLayer.clearLayers();
      return fetch(apiUrl)
        .then(r => {
          if(!r.ok) throw new Error('Erreur HTTP ' + r.status);
          return r.json();
        })
        .then(data => {
          const items = data.results || data;
          if(!items || items.length === 0) return items;
          items.forEach(i => addIncidentMarker(i));
          return items;
        });
    }

    // expose quelques utilitaires
    return {
      map,
      incidentsLayer,
      tiles,
      addIncidentMarker,
      loadIncidents
    };
  }

  return { createMap };
})(); // fin module
</script>


<nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top">
  <div class="container-fluid">
    <a class="navbar-brand" href="{% url 'home' %}">Anti-feu Bukavu</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarsExample07"
      aria-controls="navbarsExample07" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarsExample07">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
        <li class="nav-item"><a class="nav-link" href="{% url 'geoloc' %}">Géolocalisation</a></li>
        <li class="nav-item"><a class="nav-link" href="{% url 'prediction' %}">Prédiction</a></li>
        <li class="nav-item"><a class="nav-link" href="{% url 'alert' %}">Alerte</a></li>
        <li class="nav-item"><a class="nav-link" href="{% url 'modelling' %}">Modélisation</a></li>
        <li class="nav-item"><a class="nav-link" href="{% url 'contact' %}">Contact</a></li>
      </ul>
      <form class="d-flex" role="search" id="site-search" onsubmit="event.preventDefault(); window.location='{% url 'search' %}?q='+document.getElementById('q').value;">
        <input id="q" class="form-control me-2" type="search" placeholder="Rechercher..." aria-label="Search">
        <button class="btn btn-outline-light" type="submit">Rechercher</button>
      </form>
    </div>
  </div>
</nav>

<main class="container">
  {% block content %}{% endblock %}
</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.min.js"></script>
</body>
</html>
