<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Anti-feu — Bukavu</title>
  <!-- Bootstrap CDN -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.min.css"/>
  <style>
    body { padding-top: 70px; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
    #map { height: 60vh; width: 100%; }
    .card-compact { padding: 0.8rem; }
  </style>
</head>
<body>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const mapEl = document.getElementById('map');
  const spinner = document.getElementById('map-spinner');

  // Vérification : Leaflet présent ?
  if (typeof L === 'undefined') {
    // cache la spinner et affiche message d'erreur visible à la place de la carte
    if (spinner) spinner.style.display = 'none';
    if (mapEl) {
      mapEl.style.display = 'block';
      mapEl.innerHTML = '<div class="alert alert-danger m-3">Leaflet n\'a pas été chargé. Vérifie que les liens CSS/JS Leaflet sont inclus dans base.html (head) et que tu as une connexion Internet pour le CDN.</div>';
    }
    console.error('Leaflet non chargé (L is undefined). Vérifie les CDN/link dans base.html.');
    return;
  }

  // Assure que le conteneur a une hauteur visible
  if (mapEl && (!mapEl.style.height || mapEl.style.height === '')) {
    mapEl.style.height = '60vh';
  }

  // show map, hide spinner
  if (spinner) spinner.style.display = 'none';
  if (mapEl) mapEl.style.display = 'block';

  // Initialise la carte
  let map;
  try {
    map = L.map('map').setView([-2.5, 28.8], 12);
  } catch (e) {
    console.error('Erreur création map Leaflet:', e);
    if (mapEl) mapEl.innerHTML = '<div class="alert alert-danger m-3">Impossible d\'initialiser la carte. Regarde la console pour plus de détails.</div>';
    return;
  }

  // TileLayer (version fixe pour éviter 404)
  L.tileLayer('http://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
  maxZoom: 20,
  subdomains:['mt0','mt1','mt2','mt3'],
  attribution: 'Google'
}).addTo(map);


  // Layer group pour incidents
  const incidentsLayer = L.layerGroup().addTo(map);

  // fonction add marker (rouge)
  function addIncidentMarker(inc, openPopup=false) {
    const lat = parseFloat(inc.latitude);
    const lng = parseFloat(inc.longitude);
    if (isNaN(lat) || isNaN(lng)) return;
    const marker = L.circleMarker([lat, lng], {
      radius: 7,
      color: '#b91c1c',
      fillColor: '#fca5a5',
      weight: 2,
      fillOpacity: 0.9
    }).addTo(incidentsLayer);
    const popupHtml = `<strong>${inc.commune || ''} ${inc.quartier || ''}</strong><br/>${inc.date || ''} ${inc.time || ''}<br/><small>Cause: ${inc.cause || ''}</small>`;
    marker.bindPopup(popupHtml, {className: 'incident-popup-red'});
    if (openPopup) marker.openPopup();
  }

  // charger incidents
  function loadIncidents() {
    incidentsLayer.clearLayers();
    fetch('/api/incidents/')
      .then(r => {
        if(!r.ok) throw new Error('Erreur HTTP ' + r.status);
        return r.json();
      })
      .then(data => {
        const items = data.results || data;
        if(!items || items.length === 0){
          // aucun incident : placer info marker
          L.marker([-2.5, 28.8]).addTo(incidentsLayer).bindPopup('Aucun incident enregistré').openPopup();
          return;
        }
        items.forEach(i => addIncidentMarker(i));
      })
      .catch(err => {
        console.error('Erreur lors du chargement des incidents:', err);
        // affiche message sous la carte
        const s = document.getElementById('stats');
        if (s) s.innerHTML = '<div class="alert alert-warning">Impossible de charger les incidents (voir console pour erreurs).</div>';
      });
  }
  loadIncidents();

  // charger stats rapides
  fetch('/api/incidents/stats/')
    .then(r => r.json())
    .then(d => {
      let html = '<ul class="list-group">';
      html += '<li class="list-group-item active">Incendies par commune</li>';
      (d.by_commune || []).slice(0,6).forEach(c => {
        html += `<li class="list-group-item d-flex justify-content-between align-items-center">${c.commune}<span class="badge bg-primary rounded-pill">${c.total}</span></li>`;
      });
      html += '</ul>';
      document.getElementById('stats').innerHTML = html;
    })
    .catch(()=> {
      document.getElementById('stats').innerHTML = '<div class="text-muted">Statistiques indisponibles</div>';
    });

});
</script>


<nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top">
  <div class="container-fluid">
    <a class="navbar-brand" href="{% url 'home' %}">Anti-feu Bukavu</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarsExample07"
      aria-controls="navbarsExample07" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarsExample07">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
        <li class="nav-item"><a class="nav-link" href="{% url 'geoloc' %}">Géolocalisation</a></li>
        <li class="nav-item"><a class="nav-link" href="{% url 'prediction' %}">Prédiction</a></li>
        <li class="nav-item"><a class="nav-link" href="{% url 'alert' %}">Alerte</a></li>
        <li class="nav-item"><a class="nav-link" href="{% url 'modelling' %}">Modélisation</a></li>
        <li class="nav-item"><a class="nav-link" href="{% url 'search' %}">Recherche</a></li>
        <li class="nav-item"><a class="nav-link" href="{% url 'contact' %}">Contact</a></li>
      </ul>
      <form class="d-flex" role="search" id="site-search" onsubmit="event.preventDefault(); window.location='{% url 'search' %}?q='+document.getElementById('q').value;">
        <input id="q" class="form-control me-2" type="search" placeholder="Rechercher..." aria-label="Search">
        <button class="btn btn-outline-light" type="submit">Rechercher</button>
      </form>
    </div>
  </div>
</nav>

<main class="container">
  {% block content %}{% endblock %}
</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.min.js"></script>
</body>
</html>
